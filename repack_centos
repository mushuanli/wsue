#   yum -y install anaconda createrepo mkisofs rsync yum-utils genisoimage anaconda
# for i in `cat cfg/rpms.txt`; do yumdownloader $i --resolve --downloadonly --destdir Pkgs ; done
#for i in `cat ${RAIN_CFGPATH}/rpms.txt`; do yumdownloader $i --destdir ${RAIN_ISOPATH}/Packages ; done

#   CENTOS_ISOPATH:     orig iso file content
#   RAIN_ISOPATH:        output iso file content
#   RAIN_CFGPATH:        config files
#   RAIN_PKGPATH:        centos release packages
#   RAIN_RPMPATH:        RAIN release packages
#   RAIN_DSTISO:         output iso file name
CENTOS_ISOPATH=/mnt/cdrom/
RAIN_ISOPATH=iso/
RAIN_CFGPATH=cfg/
RAIN_PKGPATH=Pkgs/
RAIN_RPMPATH=rpms/
RAIN_DSTISO=RAIN6.iso

#   1.  prepare iso files from centos
#       Packages/   put all packages (and its dependence) need to install 
#                   if miss package, will warning Install software missing, and need to check /tmp/packaging.log to add missing packages
#       repodata/   put packages repo info(recreated by createrepo command)
#       .discinfo   Install script will check this file, if miss, will report install CD not found
rm -rf ${RAIN_DSTISO} ${RAIN_ISOPATH}/{Packages,repodata}
mkdir -p ${RAIN_ISOPATH}/{Packages,repodata}
/usr/bin/rsync -a --exclude=Packages/ --exclude=repodata/ ${CENTOS_ISOPATH} ${RAIN_ISOPATH}
cp -a  ${CENTOS_ISOPATH}/.discinfo ${RAIN_ISOPATH}/
cp -a  ${CENTOS_ISOPATH}/.treeinfo ${RAIN_ISOPATH}/
cp -a  ${RAIN_PKGPATH}/* ${RAIN_ISOPATH}/Packages
#rm -f  ${RAIN_ISOPATH}/Packages/kernel-*
rm -f  ${RAIN_ISOPATH}/Packages/libvirt-*

#   can copy other file into iso:
#       cp other/files/ ${RAIN_ISOPATH}/my_dir/
#   in install script:
#       cp /run/install/repo/my_dir/* /mnt/sysimage/my_dest/

#   2.  replace RAIN files
cp -a ${RAIN_RPMPATH}/*.rpm ${RAIN_ISOPATH}/Packages
cp -a ${RAIN_CFGPATH}/isolinux.cfg  ${RAIN_ISOPATH}/isolinux/
chown root.root ${RAIN_ISOPATH}/isolinux/isolinux.cfg
chmod 644 ${RAIN_ISOPATH}/isolinux/isolinux.cfg
cp -a ${RAIN_CFGPATH}/ks.conf  ${RAIN_ISOPATH}/isolinux/


# this only for centos 6, else will report such error:
# 	RepoError after 10 retries: Insufficient space in download directory /run/install/repo/Packages
# declare -x discinfo=$(head -1 ${RAIN_ISOPATH}/.discinfo)
# cp -a ${RAIN_CFGPATH}/comps.xml  ${RAIN_ISOPATH}/repodata/ ; cd ${RAIN_ISOPATH}/ && createrepo  -u "media://$discinfo" -g  repodata/comps.xml ./ ; cd -

cp -a ${RAIN_CFGPATH}/comps.xml  ${RAIN_ISOPATH}/repodata/ ; cd ${RAIN_ISOPATH}/ && createrepo  -g  repodata/comps.xml ./ ; cd -

#   -V LABEL must same with isolinux.cfg's LABEL, 
#	else will report install media not found
#	let you choose install media
genisoimage -untranslated-filenames -V RAIN6.0 -J -joliet-long -rational-rock -translation-table -input-charset utf-8 -x ./lost+found -b isolinux/isolinux.bin -c isolinux/boot.cat -no-emul-boot -boot-load-size 4 -boot-info-table -eltorito-alt-boot -e images/efiboot.img -no-emul-boot -o ${RAIN_DSTISO} -T iso/

checkisomd5 ${RAIN_DSTISO}
